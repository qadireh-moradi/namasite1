
$(function () {
    check_rkey()
})
//<!---------------CHECK USERID TO FINGER OUT THE NEXT LEVEL--------------->//
function next_level(element, event) {
    check_login(element, event)
}
//<!---------------GET COOKIE--------------->//
function get_cookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
//<!---------------DELETE COOKIE--------------->//
function delete_cookie(name, path, domain) {
    if (get_cookie(name)) {
        localStorage_getUser();
        document.cookie = name + "=" +
            ((path) ? ";path=" + path : "") +
            ((domain) ? ";domain=" + domain : "") +
            ";expires=Thu, 01 Jan 1970 00:00:01 GMT";
    }
}
//<!---------------DELETE LOCALSTORAGE--------------->//
function localStorage_getUser() {
    let getUserObject = localStorage.getItem('userObject');
    let jsonUser = JSON.parse(getUserObject);
    if (jsonUser) {
        localStorage.removeItem('userObject');
        console.log('localStorage has removeed');
    }
}
//<!---------------CHECK RKEY--------------->//
function check_login(element, event) {
    if (document.querySelector(".create_factor_form")) {
        document.querySelector(".create_factor_form").remove();
    }
    var rkey = get_cookie("rkey")
    fetch(`https://trust-login.com/server1/checkrkey/${rkey}`, {
            method: 'GET',
        })
        .then(response => response.json())
        .then(result => {
            if (result.checked == false) {
                window.location = "/login.bc"
            } else {
                let getUserObject = localStorage.getItem('userObject');
                let jsonUser = JSON.parse(getUserObject);
                var firstname_value = "";
                var lastname_value = "";
                var mobile_value = "";
                if (jsonUser) {
                    firstname_value = jsonUser.firstname;
                    lastname_value = jsonUser.lastname;
                    mobile_value = jsonUser.mobile;
                }else{
                    firstname_value = document.querySelector(".first-name-user").innerText;
                    lastname_value = document.querySelector(".last-name-user").innerText;
                    mobile_value = document.querySelector(".mobile-user").innerText;
                }
                if (element.getAttribute("data-key") == 'cart') {
                    const checkout_items = document.querySelector(".checkout-items");
                    const checkout_item = checkout_items.querySelectorAll(".checkout-item");
                    var actions = new Array();
                    for (var i = 0; i < checkout_item.length; i++) {
                        var obj = new Object();
                        obj.request = "add";
                        obj.mid = "43";
                        obj.productid = checkout_item[i].querySelector(".inventoryid-value").value;
                        obj.count = checkout_item[i].querySelector(".basket_count").value;
                        actions.push(obj)
                    }
                    var obj_product = new Object();
                    obj_product["actions"] = actions
                    var obj_user = new Object();
                    obj_user.firstname = firstname_value;
                    obj_user.lastname = lastname_value;
                    obj_user.mobile = mobile_value;
                    var obj_userinfo = new Object();
                    obj_userinfo["userinfo"] = obj_user
                    var obj_final = Object.assign({}, obj_product, obj_userinfo);
                    element.insertAdjacentHTML('beforeend', `<form method="post" action="/check-user-address" class="create_factor_form"><input type="hidden" value='${JSON.stringify(obj_final)}' name="create_factor_json"/></form>`)
                    document.querySelector(".create_factor_form").submit();
                } else if (element.getAttribute("data-key") == 'cart-drop') {
                    const cart_dropdown_info = document.querySelector(".cart-dropdown-info ul");
                    const cart_dropdown_list = cart_dropdown_info.querySelectorAll(".cart-dropdown-list");
                    var actions = new Array();
                    for (var i = 0; i < cart_dropdown_list.length; i++) {
                        var obj = new Object();
                        obj.request = "add";
                        obj.mid = "43";
                        obj.productid = cart_dropdown_list[i].getAttribute('data-id');
                        obj.count = cart_dropdown_list[i].getAttribute('data-count');
                        actions.push(obj)
                    }
                    var obj_product = new Object();
                    obj_product["actions"] = actions
                    var obj_user = new Object();
                    obj_user.firstname = firstname_value;
                    obj_user.lastname = lastname_value;
                    obj_user.mobile = mobile_value;
                    var obj_userinfo = new Object();
                    obj_userinfo["userinfo"] = obj_user
                    var obj_final = Object.assign({}, obj_product, obj_userinfo);
                    element.insertAdjacentHTML('beforeend', `<form method="post" action="/check-user-address" class="create_factor_form"><input type="hidden" value='${JSON.stringify(obj_final)}' name="create_factor_json"/></form>`)
                    document.querySelector(".create_factor_form").submit();
                }
            }
        })
        .catch(error => console.error(error))
}


function prev_level(element, event) {
    if (document.querySelector(".create_factor_form")) {
        document.querySelector(".create_factor_form").remove();
    }
    if (element.getAttribute("data-key") == 'shipping') {
        let getUserObject = localStorage.getItem('userObject');
        let jsonUser = JSON.parse(getUserObject);
        var firstname_value = "";
        var lastname_value = "";
        var mobile_value = "";
        if (jsonUser) {
            firstname_value = jsonUser.firstname;
            lastname_value = jsonUser.lastname;
            mobile_value = jsonUser.mobile;
        }else{
            firstname_value = document.querySelector(".first-name-user").innerText;
            lastname_value = document.querySelector(".last-name-user").innerText;
            mobile_value = document.querySelector(".mobile-user").innerText;
        }
        const cart_dropdown_info = document.querySelector(".cart-dropdown-info ul");
        const cart_dropdown_list = cart_dropdown_info.querySelectorAll(".cart-dropdown-list");
        var actions = new Array();
        for (var i = 0; i < cart_dropdown_list.length; i++) {
            var obj = new Object();
            obj.request = "add";
            obj.mid = "43";
            obj.productid = cart_dropdown_list[i].getAttribute('data-id');
            obj.count = cart_dropdown_list[i].getAttribute('data-count');
            actions.push(obj)
        }
        var obj_product = new Object();
        obj_product["actions"] = actions
        var obj_user = new Object();
        obj_user.firstname = firstname_value;
        obj_user.lastname = lastname_value;
        obj_user.mobile = mobile_value;
        var obj_userinfo = new Object();
        obj_userinfo["userinfo"] = obj_user
        var obj_final = Object.assign({}, obj_product, obj_userinfo);
        element.insertAdjacentHTML('beforeend', `<form method="post" action="/check-user-address" class="create_factor_form"><input type="hidden" value='${JSON.stringify(obj_final)}' name="create_factor_json"/></form>`)
        document.querySelector(".create_factor_form").submit();
    }
}

function check_rkey() {
       if (document.querySelector(".login_btn")) {
        var rkey = get_cookie("rkey");
        var userid_value;
        fetch(`https://trust-login.com/server1/checkrkey/${rkey}`, {
                method: 'GET',
            })
            .then(response => response.json())
            .then(result => {
                if (result.checked == false) {
                    document.querySelector(".login_btn").innerHTML = '<a class="login" href="/login.bc">  <span class="s-d-f"> ورود <span class="mrg-s">|</span>عضویت</span><img src="images/Group(1).png" alt=""></a>'
                } else {
                    get_userid_value(result.userid);
                    document.querySelector(".login_btn").innerHTML = '<div class="user_name" onclick="show_profile(event)"><img src="/images/user.png"   alt="img-profile" /></div>'
                }
            })
            .catch(error => console.error(error))
    }
    if (document.querySelector(".login_btn1")) {
        var rkey = get_cookie("rkey");
        var userid_value;
        fetch(`https://trust-login.com/server1/checkrkey/${rkey}`, {
                method: 'GET',
            })
            .then(response => response.json())
            .then(result => {
                if (result.checked == false) {
                    document.querySelector(".login_btn1").innerHTML = '<a class="login" href="/login.bc">  <span class="s-d-f"> ثبت نام<span class="mrg-s">/</span>ورود</span><img src="/images/user.png" /></a>'
                } else {
                    get_userid_value(result.userid);
                    document.querySelector(".login_btn1").innerHTML = '<div class="user_name" onclick="show_profilee(event)"><img src="/images/user.png"   alt="img-profile" /></div>'
                }
            })
            .catch(error => console.error(error))
    }
}
async function get_userid_value(element) {
    userid_value = element;
    return userid_value
}
//<!---------------GET CURRENCY OF PANEL--------------->//
var unit_value;
async function OnProcessingGetCurrency(args) {
    const Title = args.source._rows.map((item) => {
        return item.Title
    });
    get_unit_value(Title);
    // document.querySelector(".check-currency-unit").setAttribute("data-unit", Title);
}
async function get_unit_value(element) {
    unit_value = element;
    return unit_value
}
//<!---------------CHECK SHOW CART DROPDOWN--------------->//
function show_cart_dropdown(event) {
    if (document.querySelector("#maincount")) {
        document.querySelector("#cart-dropdown-content").classList.toggle("unvisible")
    }
}
//<!---------------SHOW PROFILE--------------->//
function show_profile(event) {
    document.querySelector("#profile_box").classList.toggle("unvisible")
}
function show_profilee(event) {
    document.querySelector("#profile_box1").classList.toggle("unvisible")
}
//<!---------------CLOSE CART DROPDOWN WHEN CLICKED ON PAGE--------------->//

if (document.getElementsByClassName('header-wrapper').length > 0) {
    var ignoreClickOnMeElement_btn_1 = document.getElementById('basket-btn');
    document.addEventListener('click', function (event) {
        var isClickInsideElement_btn_1 = ignoreClickOnMeElement_btn_1.contains(event.target);
        if (!isClickInsideElement_btn_1) {
            document.getElementById('cart-dropdown-content').classList.add("unvisible")
        }
    });


    //<!---------------CLOSE PROFILE BOX WHEN CLICKED ON PAGE--------------->//
    var ignoreClickOnMeElement_btn_2 = document.getElementById('login-btn');
    document.addEventListener('click', function (event) {
        var isClickInsideElement_btn_2 = ignoreClickOnMeElement_btn_2.contains(event.target);
        if (!isClickInsideElement_btn_2) {
            document.getElementById('profile_box').classList.add("unvisible")
        }
    });
}
//<!---------------SHOW NAME OF USER WHO IS LOGINED--------------->//
const first_name_user = document.querySelector(".first-name-user");
const last_name_user = document.querySelector(".last-name-user");
const mobile_user = document.querySelector(".mobile-user");
async function onProcessedUserInfo(args) {
    const response = args.response;
    if (response.status == 200) {
        const responseJson = await response.json();
        for (const element of responseJson) {
            if (element.prpid == 1) {
                first_name_user.innerHTML = element.answer
            }
            if (element.prpid == 2) {
                last_name_user.innerHTML = element.answer
            }
            if (element.prpid == 5) {
                mobile_user.innerHTML = element.answer
            }
        }
    }
};
//<!---------------Log OUT--------------->//
async function onProcessedLogOut(args) {
    const response = args.response;
    if (response.status == 200) {
        const responseJson = await response.json();
        const errorid = responseJson.errorid;
        const message = responseJson.message;
        if (errorid) {
            if (errorid == 30) {
                // successful 

                delete_cookie("rkey")
                window.location = "/"
                localStorage.clear();
            } else {
                // invalid inputs / invalid rkey 
                console.log(message)
            }
        }

    }
};
//<!---------------SEPERATE UNMBER TO THREE DIGITS--------------->//
async function OnRenderedSeparateBasketTotal() {
    for (var i = 0; i < document.getElementsByClassName('total-amount').length; i++) {
        const Seprated = parseInt(document.getElementsByClassName('total-amount')[i].innerText).toLocaleString()
        document.getElementsByClassName('total-amount')[i].innerText = Seprated;
    }
    for (var i = 0; i < document.getElementsByClassName('unit').length; i++) {
        document.getElementsByClassName('unit')[i].innerText = unit_value;
    }
}
//<!---------------DELETE A PRODUCT FROM BASKET--------------->//
async function delete_inventory(element, id, price, productTitle, inventoryTitle, image, productid, discount) {
    $bc.setSource("cms.add", true)
    $bc.setSource("db.add", {
        "id": id,
        "price": price,
        "ptitle": productTitle,
        "ititle": inventoryTitle,
        "quantity": 0,
        "image": image,
        "productid": productid,
        "discount": discount,
    })
    window.location.reload();
}


